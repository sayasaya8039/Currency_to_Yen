{"version":3,"file":"background/service-worker.js","mappings":"mBAcA,MAGMA,EAAiB,KAGvB,IAAIC,EAAkC,KAMtCC,eAAeC,IAEb,GAAIF,GAAeG,KAAKC,MAAQJ,EAAYK,UAAYN,EAEtD,OADAO,QAAQC,IAAI,kCACLP,EAIT,IACE,MAAMQ,QAAeC,OAAOC,QAAQC,MAAMC,IAAI,eAC9C,GAAIJ,EAAOK,YAAa,CACtB,MAAMC,EAASN,EAAOK,YACtB,GAAIV,KAAKC,MAAQU,EAAOT,UAAYN,EAGlC,OAFAO,QAAQC,IAAI,oCACZP,EAAcc,EACPA,CAEX,CACF,CAAE,MAAOC,GACPT,QAAQU,KAAK,kCAAmCD,EAClD,CAGAT,QAAQC,IAAI,uCAEZ,MAAMU,QAAiBC,MAAM,kDAE7B,IAAKD,EAASE,GACZ,MAAM,IAAIC,MAAM,YAAYH,EAASI,UAAUJ,EAASK,cAG1D,MAAMC,QAAmCN,EAASO,OAI5CC,EAAsC,CAAC,EAE7C,IAAK,MAAOC,EAAMC,KAASC,OAAOC,QAAQN,EAAKE,OAE7CA,EAAMC,GAAwB,EAAIC,EAIpCF,EAA2B,IAAI,EAE/B,MAAMZ,EAA2B,CAC/BY,QACAK,KAAMP,EAAKO,KACXzB,UAAWF,KAAKC,OAIlBJ,EAAca,EAEd,UACQJ,OAAOC,QAAQC,MAAMoB,IAAI,CAAElB,gBACjCP,QAAQC,IAAI,iCACd,CAAE,MAAOQ,GACPT,QAAQU,KAAK,gCAAiCD,EAChD,CAEA,OAAOF,CACT,CAwBAZ,eAAe+B,IACb,MAAMC,EAAsC,CAC1CC,SAAS,EACTC,oBAAoB,EACpBC,aAAc,KAGhB,IACE,MAAM5B,QAAeC,OAAOC,QAAQ2B,KAAKzB,IAAI,YAC7C,MAAO,IAAKqB,KAAqBzB,EAAO8B,SAC1C,CAAE,MACA,OAAOL,CACT,CACF,CAiBAxB,OAAO8B,QAAQC,UAAUC,YAAY,CAACC,EAASC,EAASC,KAChC3C,WACpB,IACE,OAAQyC,EAAQG,MACd,IAAK,iBAAkB,CACrB,MAAM,OAAEC,EAAM,SAAEC,GAAaL,EACvBM,QAvDhB/C,eACE6C,EACAG,GAEA,MAAM,MAAExB,EAAK,KAAEK,SAAe5B,IAExByB,EAAOF,EAAMwB,GACnB,IAAKtB,EACH,MAAM,IAAIP,MAAM,WAAW6B,KAK7B,MAAO,CAAEC,IAFGJ,EAASnB,EAEPA,OAAMG,OACtB,CAyC+BqB,CAAaL,EAAQC,GAC1C,MAAO,CAAEK,SAAS,EAAM7B,KAAMyB,EAChC,CAEA,IAAK,gBAEH,MAAO,CAAEI,SAAS,EAAM7B,WADJrB,KAItB,IAAK,eAEH,MAAO,CAAEkD,SAAS,EAAM7B,WADDS,KAIzB,IAAK,eAEH,MAAO,CAAEoB,SAAS,EAAM7B,WAlClCtB,eACEqC,GAEA,MACMe,EAAU,UADMrB,OACWM,GAIjC,aAFM7B,OAAOC,QAAQ2B,KAAKN,IAAI,CAAEO,SAAUe,IAEnCA,CACT,CAwBiCC,CAAYZ,EAAQJ,WAI7C,QACE,MAAO,CAAEc,SAAS,EAAOG,MAAO,eAEtC,CAAE,MAAOxC,GACP,MAAMwC,EAAQxC,aAAeK,MAAQL,EAAI2B,QAAU,SAEnD,OADApC,QAAQiD,MAAM,yBAA0BA,GACjC,CAAEH,SAAS,EAAOG,QAC3B,GAGFC,GAAgBC,KAAKb,IACd,IAITnC,OAAO8B,QAAQmB,YAAYjB,YAAYxC,MAAO0D,IAI5C,GAHArD,QAAQC,IAAI,sCAAuCoD,EAAQC,QAGpC,YAAnBD,EAAQC,OACV,UACQ1D,IACNI,QAAQC,IAAI,mCACd,CAAE,MAAOQ,GACPT,QAAQU,KAAK,kCAAmCD,EAClD,IAIJT,QAAQC,IAAI,2C","sources":["webpack://currency-to-yen/./src/background/service-worker.ts"],"sourcesContent":["/**\n * Service Worker - 為替レートAPI通信とキャッシュ管理\n */\n\nimport type {\n  CurrencyCode,\n  CachedRates,\n  ExchangeRateResponse,\n  ExtensionSettings,\n  MessageResponse,\n  DEFAULT_SETTINGS,\n} from '../types/currency';\n\n/** Frankfurter API エンドポイント */\nconst API_BASE = 'https://api.frankfurter.dev/v1';\n\n/** キャッシュ有効期間（1時間） */\nconst CACHE_DURATION = 60 * 60 * 1000;\n\n/** メモリキャッシュ（Service Worker内） */\nlet memoryCache: CachedRates | null = null;\n\n/**\n * 為替レートを取得（キャッシュ優先）\n * JPYを基準として他の通貨のレートを取得\n */\nasync function getExchangeRates(): Promise<CachedRates> {\n  // 1. メモリキャッシュ確認\n  if (memoryCache && Date.now() - memoryCache.fetchedAt < CACHE_DURATION) {\n    console.log('[Currency to Yen] メモリキャッシュから取得');\n    return memoryCache;\n  }\n\n  // 2. chrome.storage.local からキャッシュ確認\n  try {\n    const stored = await chrome.storage.local.get('cachedRates');\n    if (stored.cachedRates) {\n      const cached = stored.cachedRates as CachedRates;\n      if (Date.now() - cached.fetchedAt < CACHE_DURATION) {\n        console.log('[Currency to Yen] ストレージキャッシュから取得');\n        memoryCache = cached;\n        return cached;\n      }\n    }\n  } catch (err) {\n    console.warn('[Currency to Yen] キャッシュ読み込みエラー:', err);\n  }\n\n  // 3. APIから取得\n  console.log('[Currency to Yen] APIから為替レートを取得中...');\n\n  const response = await fetch(`${API_BASE}/latest?base=JPY`);\n\n  if (!response.ok) {\n    throw new Error(`API エラー: ${response.status} ${response.statusText}`);\n  }\n\n  const data: ExchangeRateResponse = await response.json();\n\n  // JPYを基準とした各通貨のレート（1通貨 = X円）を計算\n  // Frankfurter APIは 1 JPY = X通貨 の形式で返すので、逆数を取る\n  const rates: Record<CurrencyCode, number> = {} as Record<CurrencyCode, number>;\n\n  for (const [code, rate] of Object.entries(data.rates)) {\n    // 1通貨 = 何円かを計算\n    rates[code as CurrencyCode] = 1 / rate;\n  }\n\n  // JPY自身のレートを追加\n  rates['JPY' as CurrencyCode] = 1;\n\n  const cachedRates: CachedRates = {\n    rates,\n    date: data.date,\n    fetchedAt: Date.now(),\n  };\n\n  // 4. キャッシュに保存\n  memoryCache = cachedRates;\n\n  try {\n    await chrome.storage.local.set({ cachedRates });\n    console.log('[Currency to Yen] キャッシュを保存しました');\n  } catch (err) {\n    console.warn('[Currency to Yen] キャッシュ保存エラー:', err);\n  }\n\n  return cachedRates;\n}\n\n/**\n * 通貨を日本円に変換\n */\nasync function convertToYen(\n  amount: number,\n  fromCurrency: CurrencyCode\n): Promise<{ yen: number; rate: number; date: string }> {\n  const { rates, date } = await getExchangeRates();\n\n  const rate = rates[fromCurrency];\n  if (!rate) {\n    throw new Error(`未対応の通貨: ${fromCurrency}`);\n  }\n\n  const yen = amount * rate;\n\n  return { yen, rate, date };\n}\n\n/**\n * 設定を取得\n */\nasync function getSettings(): Promise<ExtensionSettings> {\n  const DEFAULT_SETTINGS: ExtensionSettings = {\n    enabled: true,\n    showOriginalAmount: true,\n    tooltipDelay: 200,\n  };\n\n  try {\n    const stored = await chrome.storage.sync.get('settings');\n    return { ...DEFAULT_SETTINGS, ...stored.settings };\n  } catch {\n    return DEFAULT_SETTINGS;\n  }\n}\n\n/**\n * 設定を保存\n */\nasync function setSettings(\n  settings: Partial<ExtensionSettings>\n): Promise<ExtensionSettings> {\n  const current = await getSettings();\n  const updated = { ...current, ...settings };\n\n  await chrome.storage.sync.set({ settings: updated });\n\n  return updated;\n}\n\n// メッセージリスナー\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n  const handleMessage = async (): Promise<MessageResponse> => {\n    try {\n      switch (message.type) {\n        case 'CONVERT_TO_YEN': {\n          const { amount, currency } = message;\n          const result = await convertToYen(amount, currency);\n          return { success: true, data: result };\n        }\n\n        case 'GET_ALL_RATES': {\n          const rates = await getExchangeRates();\n          return { success: true, data: rates };\n        }\n\n        case 'GET_SETTINGS': {\n          const settings = await getSettings();\n          return { success: true, data: settings };\n        }\n\n        case 'SET_SETTINGS': {\n          const settings = await setSettings(message.settings);\n          return { success: true, data: settings };\n        }\n\n        default:\n          return { success: false, error: '不明なメッセージタイプ' };\n      }\n    } catch (err) {\n      const error = err instanceof Error ? err.message : '不明なエラー';\n      console.error('[Currency to Yen] エラー:', error);\n      return { success: false, error };\n    }\n  };\n\n  handleMessage().then(sendResponse);\n  return true; // 非同期レスポンスを示す\n});\n\n// 拡張機能インストール時の初期化\nchrome.runtime.onInstalled.addListener(async (details) => {\n  console.log('[Currency to Yen] 拡張機能がインストールされました:', details.reason);\n\n  // 初回インストール時に為替レートを事前取得\n  if (details.reason === 'install') {\n    try {\n      await getExchangeRates();\n      console.log('[Currency to Yen] 初期為替レートを取得しました');\n    } catch (err) {\n      console.warn('[Currency to Yen] 初期為替レート取得に失敗:', err);\n    }\n  }\n});\n\nconsole.log('[Currency to Yen] Service Worker が起動しました');\n"],"names":["CACHE_DURATION","memoryCache","async","getExchangeRates","Date","now","fetchedAt","console","log","stored","chrome","storage","local","get","cachedRates","cached","err","warn","response","fetch","ok","Error","status","statusText","data","json","rates","code","rate","Object","entries","date","set","getSettings","DEFAULT_SETTINGS","enabled","showOriginalAmount","tooltipDelay","sync","settings","runtime","onMessage","addListener","message","_sender","sendResponse","type","amount","currency","result","fromCurrency","yen","convertToYen","success","updated","setSettings","error","handleMessage","then","onInstalled","details","reason"],"ignoreList":[],"sourceRoot":""}