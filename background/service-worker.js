(()=>{"use strict";const e=36e5;let t=null;async function n(){if(t&&Date.now()-t.fetchedAt<e)return console.log("[Currency to Yen] メモリキャッシュから取得"),t;try{const n=await chrome.storage.local.get("cachedRates");if(n.cachedRates){const r=n.cachedRates;if(Date.now()-r.fetchedAt<e)return console.log("[Currency to Yen] ストレージキャッシュから取得"),t=r,r}}catch(e){console.warn("[Currency to Yen] キャッシュ読み込みエラー:",e)}console.log("[Currency to Yen] APIから為替レートを取得中...");const n=await fetch("https://api.frankfurter.dev/v1/latest?base=JPY");if(!n.ok)throw new Error(`API エラー: ${n.status} ${n.statusText}`);const r=await n.json(),c={};for(const[e,t]of Object.entries(r.rates))c[e]=1/t;c.JPY=1;const s={rates:c,date:r.date,fetchedAt:Date.now()};t=s;try{await chrome.storage.local.set({cachedRates:s}),console.log("[Currency to Yen] キャッシュを保存しました")}catch(e){console.warn("[Currency to Yen] キャッシュ保存エラー:",e)}return s}async function r(){const e={enabled:!0,showOriginalAmount:!0,tooltipDelay:200};try{const t=await chrome.storage.sync.get("settings");return{...e,...t.settings}}catch{return e}}chrome.runtime.onMessage.addListener((e,t,c)=>((async()=>{try{switch(e.type){case"CONVERT_TO_YEN":{const{amount:t,currency:r}=e,c=await async function(e,t){const{rates:r,date:c}=await n(),s=r[t];if(!s)throw new Error(`未対応の通貨: ${t}`);return{yen:e*s,rate:s,date:c}}(t,r);return{success:!0,data:c}}case"GET_ALL_RATES":return{success:!0,data:await n()};case"GET_SETTINGS":return{success:!0,data:await r()};case"SET_SETTINGS":return{success:!0,data:await async function(e){const t={...await r(),...e};return await chrome.storage.sync.set({settings:t}),t}(e.settings)};default:return{success:!1,error:"不明なメッセージタイプ"}}}catch(e){const t=e instanceof Error?e.message:"不明なエラー";return console.error("[Currency to Yen] エラー:",t),{success:!1,error:t}}})().then(c),!0)),chrome.runtime.onInstalled.addListener(async e=>{if(console.log("[Currency to Yen] 拡張機能がインストールされました:",e.reason),"install"===e.reason)try{await n(),console.log("[Currency to Yen] 初期為替レートを取得しました")}catch(e){console.warn("[Currency to Yen] 初期為替レート取得に失敗:",e)}}),console.log("[Currency to Yen] Service Worker が起動しました")})();
//# sourceMappingURL=service-worker.js.map